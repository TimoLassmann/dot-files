#+TITLE:  My emacs config
#+AUTHOR: Timo Lassmann
#+DATE:   2021-04-17
#+STARTUP: overview
#+LATEX_CLASS: report
#+OPTIONS:  toc:nil
#+OPTIONS: H:4
#+LATEX_CMD: pdflatex
#+PROPERTY: header-args:emacs-lisp :exports code
* Introduction

All my emacs config.
* Basic settings
** Get rid of custom-set stuff

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'cus-edit
  ;; Disable the damn thing
  (setq custom-file (make-temp-file "emacs-custom-")))

#+END_SRC

#+RESULTS:
: /tmp/emacs-custom-hNWidf

** Directory paths

#+BEGIN_SRC emacs-lisp
(defconst tl/emacs-directory (concat (getenv "HOME") "/.emacs.d/"))
(defun tl/emacs-subdirectory (d) (expand-file-name d tl/emacs-directory))
#+END_SRC

** Whoami

#+BEGIN_SRC emacs-lisp
(setq user-full-name "Timo Lassmann"
      user-mail-address "timo.lassmann@telethonkids.org.au")
#+END_SRC

** Settings
#+BEGIN_SRC emacs-lisp

(defalias 'yes-or-no-p 'y-or-n-p)

(setq ring-bell-function 'ignore)

(setq-default cursor-type 'box)
(setq-default cursor-in-non-selected-windows '(bar . 2))
(setq-default blink-cursor-blinks 50)
(setq-default blink-cursor-interval nil) ; 0.75 would be my choice
(setq-default blink-cursor-delay 0.2)

(blink-cursor-mode -1)

#+END_SRC

** Bidirectional writing and so-long.el
(from prot)
#+BEGIN_SRC emacs-lisp

(setq-default bidi-paragraph-direction 'left-to-right)
(setq bidi-inhibit-bpa t)
(require 'so-long)
(global-so-long-mode 1)
#+END_SRC

** No easy keys


#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'no-easy-keys
  (no-easy-keys 1)
  )
#+END_SRC

#+RESULTS:
: t

** Kill buffer
Assume that I always want to kill the current buffer when hitting C-x k.
#+BEGIN_SRC emacs-lisp
(defun tl/kill-current-buffer ()
  "Kill the current buffer without prompting."
  (interactive)
  (kill-buffer (current-buffer)))
(global-set-key (kbd "C-x k") 'tl/kill-current-buffer)
#+END_SRC

** Turn off some default key-bindings
I keep hitting this by accidental
#+BEGIN_SRC emacs-lisp
(global-unset-key (kbd "C-z"))
(global-unset-key (kbd "C-x C-z"))
(global-unset-key (kbd "C-h h"))
(global-unset-key (kbd "C-x C-c"))


(defun tl/quit-emacs ()
  "Kill the current buffer without prompting."
  (interactive)
  (save-buffers-kill-terminal))

#+END_SRC

** Tabs vs spaces

Never use tabs. Tabs are the devilâ€™s whitespace.

#+BEGIN_SRC emacs-lisp
(setq-default tab-width 4)
(setq-default indent-tabs-mode nil)

;; (setq-default tab-always-indent 'complete)
#+END_SRC

#+RESULTS:


** Common functions

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'tl-common
  (global-set-key [remap move-beginning-of-line] 'smarter-move-beginning-of-line)
  (global-set-key [remap org-beginning-of-line]  'smarter-move-beginning-of-line)


  (define-key global-map (kbd "C-x 3") #'split-and-follow-vertically)
  (define-key global-map (kbd "C-x 2") #'split-and-follow-horizontally)
  )
#+END_SRC

* Main looks

** My simple theme

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'simple-theme
  (simple-theme-load-theme)

  )
#+END_SRC

#+RESULTS:
: t



** Fonts

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'tl-fonts
  (tl/setup-fonts)
  )
#+END_SRC

* Convenience
** Undo Tree
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'undo-tree
  (global-undo-tree-mode 1))

#+END_SRC

** which-key
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'which-key
  ;; NOTE: I only use this for `embark' and `consult' and for the sake
  ;; of producing more user-friendly video demonstrations.
  (setq which-key-dont-use-unicode t)
  (setq which-key-add-column-padding 2)

  ;; (setq which-key-setup-side-window-bottom)
  (setq which-key-show-early-on-C-h t)
  (setq which-key-idle-delay 10000)
  (setq which-key-idle-secondary-delay 0.05)
  (which-key-setup-minibuffer)
  ;; (setq which-key-popup-type 'side-window)
  ;; (which-key-setup-side-window-bottom)
  (setq which-key-show-prefix 'echo)
  (setq which-key-max-display-columns 3)
  (setq which-key-separator "  ")
  (setq which-key-special-keys nil)
  (setq which-key-paging-key "<next>")
  (which-key-mode))     ; and turn this on, if you want to use this
#+END_SRC

** saveplace

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'saveplace
  (save-place-mode))
#+END_SRC

** recentf
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'recentf
  (setq recentf-save-file "~/.emacs.d/recentf")
  (setq recentf-max-menu-items 10)
  (setq recentf-max-saved-items 200)
  (setq recentf-show-file-shortcuts-flag nil)
  (add-to-list 'recentf-exclude
               (expand-file-name "~/.emacs.d/company-statistics-cache.el"))
  (recentf-mode 1)
  )
#+END_SRC

** Async

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'async)

#+END_SRC

#+RESULTS:

** Rainbow

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'rainbow-mode
  )
#+END_SRC

* Moving
** Switch windows


#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'switch-window
  (setq switch-window-input-style 'minibuffer)
  (setq switch-window-increase 4)
  (setq switch-window-threshold 2)
  (setq switch-window-shortcut-style 'qwerty)
  (setq switch-window-qwerty-shortcuts
        '("a" "s" "d" "f" "j" "k" "l" "i" "o"))
  (global-set-key [remap other-window]  'switch-window))

#+END_SRC

** Beginend

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'beginend
  (beginend-global-mode 1))

#+END_SRC

** Goto last Change

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'goto-last-change
  (define-key global-map (kbd "C-z") #'goto-last-change))
#+END_SRC

** Avy

#+BEGIN_SRC emacs-lisp

(prot-emacs-elpa-package 'avy
  (global-set-key (kbd "M-SPC") 'avy-goto-char-timer)
  (global-set-key (kbd "C-:") 'avy-goto-char)
  (global-set-key (kbd "C-'") 'avy-goto-char-2)
  (global-set-key (kbd "M-g f") 'avy-goto-line)
  (global-set-key (kbd "M-g w") 'avy-goto-word-1)
  (global-set-key (kbd "M-g e") 'avy-goto-word-0))


#+END_SRC

** Beacon
#+BEGIN_SRC emacs-lisp

(prot-emacs-elpa-package 'beacon
  (setq beacon-push-mark 10)
  (setq beacon-blink-delay 0.3)
  (setq beacon-blink-duration 0.3)
  (beacon-mode)
  (global-hl-line-mode 1))
#+END_SRC

#+RESULTS:
: t

* Completion
** Company

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'company
  (setq company-auto-complete nil)
  (setq company-dabbrev-code-everywhere t)
  (setq company-dabbrev-code-modes t)
  (setq company-dabbrev-code-other-buffers 'all)
  (setq company-dabbrev-downcase nil)
  (setq company-dabbrev-ignore-case t)
  (setq company-dabbrev-other-buffers 'all)
  (setq company-idle-delay 0.3)
  (setq company-minimum-prefix-length 3)
  (setq company-require-match nil)
  (setq company-selection-wrap-around t)
  (setq company-show-numbers t)
  (setq company-tooltip-align-annotations t)
  (setq company-tooltip-limit 10)
  (setq company-tooltip-margin 1)
  (setq company-tooltip-offset-display 'scrollbar)
  (add-to-list 'company-backends '(company-clang
                                   company-capf
                                   company-dabbrev
                                   company-c-headers
                                   company-gtags))
  (let ((map company-mode-map))
    (define-key map (kbd "M-/") #'company-manual-begin))
  (let ((map company-active-map))
    (define-key map (kbd "M-/") #'company-other-backend)
    (define-key map (kbd "<tab>") #'company-complete-selection)
    (define-key map (kbd "<C-tab>") #'company-complete-common-or-cycle)
    (define-key map (kbd "C-n") #'company-select-next)
    (define-key map (kbd "C-p") #'company-select-previous))

  (setq company-global-modes '(
                               org-mode
                               c-mode
                               c++-mode
                               ))

  ;; (add-hook 'c-mode-hook
  ;;           (lambda ()
  ;;             (set (make-local-variable 'company-backends)
  ;;                  '(company-clang  company-gtags  company-c-headers company-dabbrev ))))

  (global-company-mode 1)
  )
#+END_SRC

Company C headers

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'company-c-headers
  )
#+END_SRC
Company Statistics
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'company-statistics
  (company-statistics-mode)
  )
#+END_SRC

I had to add the hook and local variable to stop company from selecting capf before clang.
To make this work properly, I need to manually specify the include paths by
putting a =.dir-locals.el= into the source directory of my C code. I.e. most
of the time this will be =src= and I need to point to
=../tldevel=.

In addition add the include path to flycheck-clang!

#+BEGIN_EXAMPLE emacs-lisp
(
(c-mode . ((company-clang-arguments . ("-I."  "-I../tldevel-1.2.8/"))))
(c-mode . ((company-c-headers-path-user . ("." "../tldevel-1.2.8/"))))
(c-mode . ((flycheck-clang-include-path . ("-I." "-I../tldevel-1.2.8/"))))
)
#+END_EXAMPLE

** Consult

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'consult
  (setq consult-line-numbers-widen t)


  (setq consult-ripgrep-command "rg -SHn --no-heading --color never --no-follow --hidden %s")
  (define-key global-map (kbd "M-s r") #'consult-git-grep)
  (define-key global-map (kbd "C-x b") #'consult-buffer)
  (define-key global-map (kbd "C-s") #'consult-line)
  (define-key global-map (kbd "C-x i") #'consult-imenu)
  (define-key global-map (kbd "C-x C-r") #'consult-recent-file)
  (define-key global-map (kbd "M-g M-g") #'consult-goto-line)
  ;; (setq consult-widen-key t)
  (setq consult-config #'((consult-buffer :title nil)))
  )
#+END_SRC

#+RESULTS:
| consult-buffer | :preview | nil |

Let's also look at consult-flycheck 

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'consult-flycheck
  )
#+END_SRC

** Orderless
#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'tl-orderless
  (setq prot-orderless-default-styles
        '(orderless-prefixes
          orderless-strict-leading-initialism
          orderless-regexp))
  (setq prot-orderless-alternative-styles
        '(orderless-literal
          orderless-prefixes
          orderless-strict-leading-initialism
          orderless-regexp)))

(prot-emacs-elpa-package 'orderless
  (setq orderless-component-separator " +")
  (setq orderless-matching-styles prot-orderless-default-styles)
  (setq orderless-style-dispatchers
        '(prot-orderless-literal-dispatcher
          prot-orderless-initialism-dispatcher
          prot-orderless-flex-dispatcher))
  ;; SPC should never complete: use it for `orderless' groups.
  (let ((map minibuffer-local-completion-map))
    (define-key map (kbd "SPC") nil)
    (define-key map (kbd "?") nil)))

;; (prot-emacs-elpa-package 'orderless
;;   (setq completion-styles '(orderless))
;;   (setq orderless-component-separator 'orderless-escapable-split-on-space))
#+END_SRC

#+RESULTS:

** Marginalia
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'marginalia
  (setq marginalia-annotators
        '(marginalia-annotators-heavy
          marginalia-annotators-light))
  (let ((map minibuffer-local-map))
    (define-key map (kbd "M-Y") #'marginalia-cycle))
  (marginalia-mode))
#+END_SRC

** Minibuffer settings

#+BEGIN_SRC emacs-lisp

(setq completion-styles '(orderless partial-completion))

(setq completion-category-overrides
      '((buffer (styles . (substring flex orderless)))
        '(file (styles . (partial-completion orderless)))))

(file-name-shadow-mode 1)
(minibuffer-depth-indicate-mode 1)
(minibuffer-electric-default-mode 1)

(defun prot-minibuffer--field-beg ()
  "Determine beginning of completion."
  (if (window-minibuffer-p)
      (minibuffer-prompt-end)
    (nth 0 completion-in-region--data)))
(defun prot-minibuffer--completion-category ()
  "Return completion category."
  (let* ((beg (prot-minibuffer--field-beg))
         (md (completion--field-metadata beg)))
    (alist-get 'category (cdr md))))

(defun prot-minibuffer-backward-updir ()
  "Delete char before point or go up a directory. Must be bound to `minibuffer-local-filename-completion-map'."
  (interactive)
  (if (and (eq (char-before) ?/)
           (eq (prot-minibuffer--completion-category) 'file))
      (save-excursion
        (goto-char (1- (point)))
        (when (search-backward "/" (point-min) t)
          (delete-region (1+ (point)) (point-max))))
    (call-interactively 'backward-delete-char)))

(let ((map minibuffer-local-filename-completion-map))
  (define-key map (kbd "<backspace>") #'prot-minibuffer-backward-updir))

#+END_SRC

** Selectrum
#+BEGIN_SRC emacs-lisp
;; (prot-emacs-elpa-package 'selectrum

;;   (defvar me/selectrum-candidates-map (make-sparse-keymap))
;;   ;; :bind
;;   ;; (("C-x C-z" . selectrum-repeat)
;;   ;;  :map me/selectrum-candidates-map
;;   ;;  ("q" . abort-recursive-edit)
;;   ;;  ([remap keyboard-quit] . abort-recursive-edit))


;;   (add-hook 'selectrum-display-action #'(lambda () (use-local-map me/selectrum-candidates-map)))

;;   (setq selectrum-display-action #'(display-buffer-at-bottom
;;                               (window-parameters (mode-line-format . none))))
;;   (setq selectrum-extend-current-candidate-highlight t)
;;   (setq selectrum-fix-vertical-window-height t)
;;   (setq selectrum-max-window-height .15)
;;   (selectrum-mode +1)
;;   )


#+END_SRC

#+RESULTS:
: t

** Icomplete
#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'icomplete
  (setq read-file-name-completion-ignore-case t)
  (setq read-buffer-completion-ignore-case t)
  (setq completion-ignore-case t)
  (let ((map icomplete-minibuffer-map))
    (define-key map (kbd "<return>") #'icomplete-force-complete-and-exit)
    (define-key map (kbd "<down>") #'icomplete-forward-completions)
    (define-key map (kbd "C-n") #'icomplete-forward-completions)
    (define-key map (kbd "<up>") #'icomplete-backward-completions)
    (define-key map (kbd "C-p") #'icomplete-backward-completions)
    (define-key map (kbd "C-v") #'icomplete-vertical-toggle)
    (define-key map (kbd "C-M-i") #'minibuffer-complete))
  (icomplete-mode))
#+END_SRC

#+RESULTS:
: t

#+BEGIN_SRC emacs-lisp
;; (prot-emacs-elpa-package 'embark
;;    (let ((map minibuffer-local-map))
;;          (define-key map (kbd "C-;") #'embark-act)))

;; :bind (:map minibuffer-local-map
;;        ("C-o" . embark-act)
;;        ("C-S-o" . embark-act-noexit)
;;        :map embark-file-map
;;        ("j" . dired-jump)))

#+END_SRC

#+RESULTS:
: embark-act

** Icomplete vertical

#+BEGIN_SRC emacs-lisp

(prot-emacs-elpa-package 'icomplete-vertical
  (icomplete-vertical-mode)
  )

#+END_SRC


** Autoinsert templates

#+begin_src emacs-lisp
(defun ha/autoinsert-yas-expand()
  "Replace text in yasnippet template."
  (yas-expand-snippet (buffer-string) (point-min) (point-max)))
(prot-emacs-builtin-package 'autoinsert

  (setq auto-insert-directory (tl/emacs-subdirectory "templates/"))
  ;; Don't want to be prompted before insertion:
  (setq auto-insert-query nil)

  (add-hook 'find-file-hook 'auto-insert)
  (auto-insert-mode 1)

  (define-auto-insert ".+work\/Project.+org$" ["default-orgmode.org"  ha/autoinsert-yas-expand])
  (define-auto-insert ".+work\/docs.+org$" ["default-orgmode.org"  ha/autoinsert-yas-expand])
  (define-auto-insert ".+code.+org$" ["default-orgmode.org"  ha/autoinsert-yas-expand])
  (auto-insert-mode 1)
  )
#+end_src

#+RESULTS:
: t

* Programming
Mostly C ....

** Compilation
Some default settings.

#+BEGIN_SRC emacs-lisp
;; (setq-default tab-width 4)
(global-subword-mode 1)
(setq compile-command "make -j 6")
(setq compilation-scroll-output 'first-error)
(setq compilation-always-kill t)
(setq compilation-disable-input t)
(setq compilation-scroll-output t)
(setq compilation-read-command nil)
(add-hook 'compilation-mode-hook 'visual-line-mode)

(global-set-key (kbd "<f5>") (lambda ()
                               (interactive)
                               (setq-local compilation-read-command nil)
                               (call-interactively 'compile)))

#+END_SRC

#+RESULTS:
| (lambda nil (add-hook 'before-save-hook 'whitespace-cleanup)) | smartparens-mode | my-c-mode-hook | (lambda nil (set (make-local-variable 'company-backends) '(company-clang company-gtags company-c-headers company-dabbrev))) |

Highlight line mode

#+BEGIN_SRC emacs-lisp
(when window-system (add-hook 'prog-mode-hook 'hl-line-mode))
#+END_SRC

** Flycheck

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'flycheck
  (setq-default flycheck-disabled-checkers '(emacs-lisp-checkdoc))
  (global-flycheck-mode 1) 
  )
(prot-emacs-elpa-package 'flycheck-clang-analyzer
  (flycheck-clang-analyzer-setup)
  )

(prot-emacs-elpa-package 'flycheck-clang-tidy
  (setq-default flycheck-clang-tidy-extra-options "--checks=-*,bugprone-*,cert-*,clang-analyzer-*,darwin-*,linuxkernel-*,misc-*,performance-*,portability-*,readability-*,-readability-magic-numbers")
  (flycheck-clang-tidy-setup)
  )
#+END_SRC

#+RESULTS:

** Indent

*** aindent mode
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'clean-aindent-mode
  (add-hook 'prog-mode-hook 'clean-aindent-mode))
#+END_SRC

*** DTRT indent

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'dtrt-indent
  (dtrt-indent-mode 1)
  (setq dtrt-indent-verbosity 0)
  )
#+END_SRC

** Yasnippet

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'yasnippet
  (add-to-list 'yas-snippet-dirs (tl/emacs-subdirectory "snippets"))
  (yas-reload-all)
  (yas-global-mode 1))
#+END_SRC

** Smart comments


#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'smart-comment
  (define-key global-map (kbd "M-;") #'smart-comment))

#+END_SRC

** Smart parens

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'smartparens
  ;; (add-hook 'c-mode-hook 'smartparens-mode)
  (add-hook 'org-mode-hook 'smartparens-mode)
  )
#+END_SRC

** Smart scan

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'smartscan
  (define-key global-map (kbd "M-n") #'smartscan-symbol-go-forward)
  (define-key global-map (kbd "M-p") #'smartscan-symbol-go-backward))
#+END_SRC

** GGtags

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'ggtags

  (setq ggtags-oversize-limit 104857600)
  (setq ggtags-sort-by-nearness t)
  (setq ggtags-use-idutils t)
  (setq ggtags-use-project-gtagsconf nil)
  ;; (add-hook 'c-mode-common-hook
  ;;           (lambda ()
  ;;             (when (derived-mode-p 'c-mode)
  ;;               (ggtags-mode 1))))

  (let ((map ggtags-navigation-map))
    (define-key map (kbd "M-u") #'ggtags-navigation-previous-file)
    (define-key map (kbd "M-o") #'ggtags-navigation-next-file)
    (define-key map (kbd "M-l") #'ggtags-navigation-visible-mode)
    (define-key map (kbd "M-j") #'ggtags-navigation-visible-mode)
    (define-key map (kbd "M-k") #'next-error)
    (define-key map (kbd "M-i") #'previous-error))

  (define-key global-map (kbd "M-;") #'smart-comment))

#+END_SRC

** Whitespace

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'whitespace
  (define-key global-map (kbd "C-c w") #'whitespace-mode)
  ;; (add-hook 'c-mode-hook
  ;;           (lambda () (add-hook 'before-save-hook 'whitespace-cleanup)))
  )
#+END_SRC

** My c config

When switching to emacs my indent etc.. setup broke for some reason.
Therefore I decided to put all of my c-mode settings in one file.

#+BEGIN_SRC emacs-lisp

(prot-emacs-builtin-package 'tl-cmode
  (add-hook 'c-mode-common-hook 'tl/setup-c-mode)
  )
#+END_SRC

#+RESULTS:
| tl/setup-c-mode |



** Lesser languages : R

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'ess
  ;; (setq-default inferior-R-program-name "/home/user/R")
  ;; (s
  (setq-default inferior-ess-r-program  "/home/user/R")

  )
#+END_SRC

#+RESULTS:
: /home/user/R

* Eshell
#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'eshell
  (require 'esh-mode)
  (require 'esh-module)
  (setq eshell-modules-list             ; It works but may need review
        '(eshell-alias
          eshell-basic
          eshell-cmpl
          eshell-dirs
          eshell-glob
          eshell-hist
          eshell-ls
          eshell-pred
          eshell-prompt
          eshell-script
          eshell-term
          eshell-tramp
          eshell-unix))

  (setenv "PAGER" "cat")
  (let ((map eshell-mode-map))
    (define-key map (kbd "C-r") #'consult-history))
  )

(prot-emacs-builtin-package 'em-alias
  (eshell/alias "ll" "/bin/ls -AlohG --color=always")
  (eshell/alias "val" "valgrind --leak-check=yes --show-leak-kinds=all --exit-on-first-error=yes --error-exitcode=1 $*")
  (eshell/alias "d" "dired $1")
  (eshell/alias "gds" "magit-diff-staged")
  (eshell/alias "gd" "magit-diff-unstaged")
  (eshell/alias "ee" "find-file-other-window $1")
  (eshell/alias "emacs" "find-file $1")
  (eshell/alias "ff" "find-file $1")
  (eshell/alias "e" "find-file $1")
  )

(prot-emacs-builtin-package 'tl-eshell
  (let ((map eshell-mode-map))
    (define-key map (kbd "C-c C-r") #'prot-eshell-root-dir))
  (let ((map eshell-hist-mode-map))
    (define-key map (kbd "C-c C-d") #'prot-eshell-complete-recent-dir)
    (define-key map (kbd "C-c C-s") #'prot-eshell-find-subdirectory-recursive)))

#+END_SRC

* Tramp

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'tramp
  (with-eval-after-load 'tramp-cache
    (setq tramp-persistency-file-name "~/.emacs.d/tramp"))
  (setq tramp-default-method "ssh")
  (setq tramp-use-ssh-controlmaster-options nil)
  (message "tramp-loaded"))

#+END_SRC

* Magit

I played with this before..

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'magit
  (setq magit-branch-arguments nil)

  ;; use ido to look for branches
  (setq magit-completing-read-function 'magit-builtin-completing-read)
  ;; don't put "origin-" in front of new branch names by default
  (setq magit-default-tracking-name-function 'magit-default-tracking-name-branch-only)
  (setq magit-push-always-verify nil)
  ;; Get rid of the previous advice to go into fullscreen
  (setq magit-restnore-window-configuration t)
  (defadvice magit-status (around magit-fullscreen activate)
    (window-configuration-to-register :magit-fullscreen)
    ad-do-it
    (delete-other-windows))
  (define-key global-map (kbd "C-x g") #'magit-status))
#+END_SRC

* Org-mode
** General setup

load org mode

#+BEGIN_SRC emacs-lisp

(prot-emacs-builtin-package 'org
  (setq org-startup-indented t)
  (setq org-hide-leading-stars t)
  (setq org-odd-level-only t)
  (setq org-indent-mode t)
  (setq org-startup-with-inline-images t)

  (setq org-src-fontify-natively t)
  (setq org-src-preserve-indentation t)
  (setq org-edit-src-content-indentation t)
  (setq org-src-tab-acts-natively t)
  (setq org-confirm-babel-evaluate nil)
  (setq org-export-with-smart-quotes t)
  (setq org-src-window-setup 'current-window)
  (setq org-display-inline-images t)

  (setq org-display-inline-images t)
  (setq org-redisplay-inline-images t)
  (setq org-startup-with-inline-images "inlineimages")

  (setq org-refile-use-outline-path 'file)

  (setq org-outline-path-complete-in-steps nil)
  (setq org-refile-allow-creating-parent-nodes (quote confirm))
  (setq org-pretty-entities t)
  (setq org-directory "~/work")
  (setq org-log-into-drawer t)
  (setq org-log-done 'time)

  (setq org-todo-keywords '((sequence
                             "TODO(t@/!)"
                             "WAITING(w@/!)"
                             "SOMEDAY(s/!)"
                             "PROG(p)"
                             "|"
                             "DONE(d@)"
                             "CANCEL(c@)"
                             "DELEGATED(@)"
                             )
                            (sequence
                             "IDEA"
                             "GOAL"
                             "|"
                             "DUD(@)")
                            ))
  ;; Add the REPORT drawer
  (setq org-drawers '("PROPERTIES" "CLOCK" "LOGBOOK" "REPORT"))
  (setq org-agenda-files '("~/work"
                           "~/work/roam"
                           "~/work/roam/dailies"
                           "~/life"))
  (setq org-capture-templates
        (quote (("t" "todo" entry (file+headline "~/work/work-todo.org" "Inbox")
                 "* TODO %?\nSCHEDULED: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n%a\n")
                ("n" "note" entry (file+headline "~/work/work-todo.org" "Inbox")
                 "* %?\n\n  %i\n\n  See: %a" :empty-lines 1)
                ("r" "respond" entry (file+headline "~/work/work-todo.org" "Inbox")
                 "* TODO Respond to %:from on %:subject\nSCHEDULED: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n%a\n")
                ("m" "Mail" entry (file+headline "~/work/work-todo.org" "Inbox")
                 "* TODO %?\n%a   %:from %:fromname %:fromaddress" :prepend t :jump-to-captured t)
                ("p" "Daily Plan" plain (file+datetree "~/planning/daily-plan.org")
                 "+ [ ] The 3 most important tasks [/]
                                                                                                                                                - [ ]
                                                                                                                                                - [ ]
                                                                                                                                                - [ ]
                                                                                                                                + [ ] Other tasks that are in the system [/]
                                                                                                                                                - [ ]
                                                                                                                                + [ ] ToDos which are not tracked by my system [/]
                                                                                                                                                - [ ] " :immediate-finish t)
                )))
  ;; Do not dim blocked tasks
  (setq org-agenda-dim-blocked-tasks nil)
  (setq org-agenda-include-deadlines t)
  ;; Compact the block agenda view
  (setq org-agenda-compact-blocks t)
  (setq org-habit-show-habits-only-for-today t)
  ;; Org Agenda Files
  ;; org agenda
  (setq org-agenda-time-grid
        (quote
         ((daily today remove-match)
          (700 800 900 1000 1100 1200 1300 1400 1500 1600 1700 1800 1900 2000 2100 2200 2300)
          "......" "----------------")))
  (setq org-agenda-custom-commands
        '(("c" "Simple agenda view"
           ((agenda "")
            (alltodo "")))))
  (setq org-refile-targets '(("~/work/work-todo.org" :maxlevel . 2)
                             ("~/work/work-todo-archive.org" :maxlevel . 2)
                             ("~/life/life-todo.org" :maxlevel . 2)
                             ))
  (setq org-use-speed-commands t
        org-return-follows-link t
        org-outline-path-complete-in-steps nil)
  (setq org-latex-listings 'minted)
  (setq org-latex-minted-options
        '(("frame" "lines")
          ("linenos=true")
          ("breaklines=true")
          ("framesep=2mm")
          ("fontsize" "\\footnotesize")
          ))
  (define-key global-map (kbd "C-c l") #'org-store-link)
  (define-key global-map (kbd "C-c a") #'org-agenda)
  (define-key global-map (kbd "C-c c") #'org-capture)
  (let ((map org-mode-map))
    (define-key map (kbd "C-c [") #'undefined))

  (add-hook 'org-mode-hook 'visual-line-mode)
  (add-hook 'org-mode-hook 'flyspell-mode)
  (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)

  )
#+END_SRC

#+RESULTS:
| org-redisplay-inline-images |


framesep=2mm,
baselinestretch=1.2,
bgcolor=LightGray,
fontsize=\footnotesize,
linenos
Record the time that a todo was archived.


** Coding

Allow babel to evaluate C ...

#+BEGIN_SRC emacs-lisp
(org-babel-do-load-languages
 'org-babel-load-languages
 '((C . t)
   (R . t)
   (dot . t)
   (emacs-lisp . t)
   (shell . t)
   (awk . t)
   (makefile . t)
   (latex . t)
   (java . t)
   (clojure . t)
   ))

#+END_SRC

Done.
** Export

Export packages...

#+BEGIN_SRC emacs-lisp
(require 'ox-latex)
(require 'ox-beamer)
#+END_SRC



** Bullets

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'org-superstar
  (add-hook 'org-mode-hook (lambda () (org-superstar-mode 1)))
  )

#+END_SRC

** Image preview

Inline images support:

# #+BEGIN_SRC emacs-lisp
# (setq org-latex-create-formula-image-program 'imagemagick)

# (add-to-list 'org-latex-packages-alist
#              '("" "tikz" t))

# (eval-after-load "preview"
#   '(add-to-list 'preview-default-preamble "\\PreviewEnvironment{tikzpicture}" t))
# (setq org-latex-create-formula-image-program 'imagemagick)


# (setq org-confirm-babel-evaluate nil)
# (add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
# (add-hook 'org-mode-hook 'org-display-inline-images)
# #+END_SRC

** Keybindings

Quickly open index file
#+BEGIN_SRC emacs-lisp
(defun open-index-file ()
  "Open the master org TODO list."
  (interactive)
  (find-file "~/work/work-todo.org")
  (flycheck-mode -1)
  (end-of-buffer))

(global-set-key (kbd "C-c i") 'open-index-file)
#+END_SRC


** Deft

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'deft

  (setq deft-default-extension "org")
  ;; de-couples filename and note title:
  (setq deft-use-filename-as-title nil)
  (setq deft-use-filter-string-for-filename t)
  ;; disable auto-save
  (setq deft-auto-save-interval -1.0)
  ;; converts the filter string into a readable file-name using kebab-case:
  (setq deft-file-naming-rules
        '((noslash . "-")
          (nospace . "-")
          (case-fn . downcase)))
  (setq    deft-directory (concat (getenv "HOME") "/work/roam/"))
  (add-to-list 'deft-extensions "tex"))

#+END_SRC

NOTE: in Emacs 27.1 the cl package has been deprecated. Therefore deft throws an error when called. To fix this find all =(require 'cl)= statements and replace with =(require 'cl-lib)=. E.g. by running =rg -F "(require 'cl)" -l=.

** Helm-bibtex

Define format for bibtex entries

#+BEGIN_SRC emacs-lisp

;; variables that control bibtex key format for auto-generation
;; I want firstauthor-year-title-words
;; this usually makes a legitimate filename to store pdfs under.
(setq bibtex-autokey-year-length 4
      bibtex-autokey-name-year-separator "-"
      bibtex-autokey-year-title-separator "-"
      bibtex-autokey-titleword-separator "-"
      bibtex-autokey-titlewords 2
      bibtex-autokey-titlewords-stretch 1
      bibtex-autokey-titleword-length 5)

(setq bibtex-completion-bibliography "~/work/bibliography/references.bib"
      bibtex-completion-library-path "~/work/bibliography/bibtex-pdfs"
      bibtex-completion-notes-path "~/work/bibliography/helm-bibtex-notes"
      bibtex-completion-pdf-field "file")

#+END_SRC

** Org-ref

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'biblio)
(prot-emacs-elpa-package 'biblio-core)
(prot-emacs-elpa-package 'org-ref


  (setq org-ref-completion-library 'org-ref-ivy-cite)
  (setq org-ref-get-pdf-filename-function 'org-ref-get-pdf-filename-helm-bibtex)
  (setq org-ref-default-bibliography '("~/work/bibliography/references.bib"))
  (setq org-ref-bibliography-notes "~/work/roam/notes.org")
  (setq org-ref-pdf-directory "~/work/bibliography/bibtex-pdfs/")
  (setq  notes-directory (concat (getenv "HOME") "/work/roam/"))
  (setq org-ref-notes-directory "~/work/roam/")
  (setq org-ref-notes-function 'orb-edit-notes)
  (setq org-ref-default-citation-link "supercite")

  (setq reftex-default-bibliography '("~/work/bibliography/references.bib")))



;; ;;Hack ....
;; (defun org-ref-add-labels (start end)
;;   "Add labels in the region from START to END.
;;        This is run by font-lock. START tends to be the beginning of the
;;        line, and END tends to be where the point is, so this function
;;        seems to work fine at recognizing labels by the regexps in
;;        `org-ref-label-regexps'."
;;   (interactive "r")
;;   (save-excursion
;;     (save-match-data
;;       (cl-loop for rx in org-ref-label-regexps
;;                do
;;                (goto-char start)
;;                (while (re-search-forward rx end t)
;;                  (let ((label (match-string-no-properties 1)))
;;                    ;; I don't know why this gets found, but some labels are
;;                    ;; empty strings. we don't store these.
;;                    (unless (string= "" label)
;;                      ;; if the last end is the new end -1 we are adding to a
;;                      ;; label, and should pop the old one off before adding the
;;                      ;; new one.
;;                      (when (eq  org-ref-last-label-end (- end 1))
;;                        (pop org-ref-labels))
;;                      (with-silent-modifications
;;                        (put-text-property (match-beginning 1)
;;                                           (match-end 1)
;;                                           'org-ref-label t)
;;                        (put-text-property (match-beginning 1)
;;                                           (match-end 1)
;;                                           'rear-nonsticky '(org-ref-label)))
;;                      (when org-ref-label-debug
;;                        (message "oral: adding %s" label))

;;                      (cl-pushnew label
;;                                  org-ref-labels :test 'string=)
;;                      ;; now store the last end so we can tell for the next run
;;                      ;; if we are adding to a label.
;;                      (setq org-ref-last-label-end end))))))))

#+END_SRC

Make =supercite= the default citation type:

Where are the refs?

End.

** Org roam

#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'org-roam

  (setq org-roam-directory "~/work/roam/")
  (setq org-roam-completion-everywhere t)
  (let ((map org-roam-mode-map))
    (define-key map (kbd "C-c m l") #'org-roam)
    (define-key map (kbd "C-c m F") #'org-roam-find-file)
    (define-key map (kbd "C-c m r") #'org-roam-find-ref)
    (define-key map (kbd "C-c m .") #'org-roam-find-directory)
    (define-key map (kbd "C-c m d") #'org-roam-dailies-today)
    (define-key map (kbd "C-c m j") #'org-roam-jump-to-index)
    (define-key map (kbd "C-c m b") #'org-roam-switch-to-buffer)
    (define-key map (kbd "C-c m g") #'org-roam-graph)
    (define-key map (kbd "C-c m G") #'org-roam-server-mode))

  (let ((map org-mode-map))
    (define-key map (kbd "C-c m i") #'org-roam-insert)
    (define-key map (kbd "C-c n a") #'orb-note-actions))

  (setq org-roam-index-file "~/work/roam/Index.org")

  (setq org-roam-capture-templates
        '(("d" "default" plain (function org-roam-capture--get-point)
           "\n* %?"
           :file-name "%<%Y%m%d%H%M%S>-${slug}"
           :head "#+title: ${title}\n#+created: %u\n#+last_modified: %U\n\n"
           :unnarrowed t)
          ("r" "ref" plain (function org-roam-capture--get-point)
           ""
           :file-name "${slug}"
           :head "#+title: ${title}\n#+roam_key: ${ref}\n#+created: %u\n#+last_modified: %U\n\n"
           :unnarrowed t)
          ("d" "Daily" plain (function org-roam-capture--get-point)
           "* %?\n"
           :add-created t
           :file-name "dailies/%<%Y-%m-%d>-${slug}"
           :head "#+TITLE: %<%Y-%m-%d>\n\n"
           :unnarrowed t))))

#+END_SRC



Org Roam protocol

#+BEGIN_SRC emacs-lisp

(require 'org-roam-protocol)
(prot-emacs-elpa-package 'org-roam-server

  (setq org-roam-server-host "127.0.0.1")
  (setq org-roam-server-port 8080)
  (setq org-roam-server-export-inline-images t)
  (setq org-roam-server-authenticate nil)
  (setq org-roam-server-network-poll t)
  (setq org-roam-server-network-arrows nil)
  (setq org-roam-server-network-label-truncate t)
  (setq org-roam-server-network-label-truncate-length 60)
  (setq org-roam-server-network-label-wrap-length 20))
#+END_SRC

Additional setup:

We need to create a file in =~/.local/share/applications/org-protocol.desktop=
#+begin_example
[Desktop Entry]
Name=Org-Protocol
Exec=emacsclient %u
Icon=emacs-icon
Type=Application
Terminal=false
MimeType=x-scheme-handler/org-protocol
#+end_example

and run :
#+begin_example bash
xdg-mime default org-protocol.desktop x-scheme-handler/org-protocol
#+end_example

** Org-roam-bibtex
#+BEGIN_SRC emacs-lisp
(prot-emacs-elpa-package 'ivy-bibtex)

(prot-emacs-elpa-package 'org-roam-bibtex
  (setq orb-preformat-keywords
        '(("citekey" . "=key=") "title" "url" "file" "author-or-editor" "keywords"))
  (setq orb-templates
        '(("r" "ref" plain (function org-roam-capture--get-point)
           ""
           :file-name "${citekey}"
           :head "#+TITLE: ${citekey}: ${title}\n#+ROAM_KEY: ${ref}

                - tags ::
                - keywords :: ${keywords}
                \n* ${title}
                :PROPERTIES:
                :Custom_ID: ${citekey}
                :URL: ${url}
                :AUTHOR: ${author-or-editor}
                :NOTER_DOCUMENT: %(orb-process-file-field \"${citekey}\")
                :NOTER_PAGE:
                :END:\n%?")))
  (add-hook 'org-roam-mode 'org-roam-bibtex-mode))
#+END_SRC


** Org-Noter

#+BEGIN_SRC  emacs-lisp
(setq
 org_notes (concat (getenv "HOME") "/work/roam/")
 deft-directory org_notes
 org-roam-directory org_notes
 )
(prot-emacs-elpa-package 'org-noter

  (setq org-noter-hide-other t)
  (setq org-noter-auto-save-last-location t)
  (setq org-noter-doc-split-fraction '(0.67 0.33))
  (setq org-noter-notes-search-path  (list org_notes)))


#+END_SRC

** Latex templates
Latex templates
#+BEGIN_SRC emacs-lisp
;;(setq org-latex-to-pdf-process '("xelatex %f && bibtex %f && xelatex %f && xelatex %f"))
(defun sk-latexmk-cmd (backend)
  "When exporting from .org with latex, automatically run latex,
                                                        pdflatex, or xelatex as appropriate, using latexmk."
  (when (org-export-derived-backend-p backend 'latex)
    (let ((texcmd)))
    ;; default command: xelatex
    (setq texcmd "jobname=$(basename %f | sed 's/\.tex//');latexmk -xelatex -shell-escape -quiet %f && mkdir -p latex.d && mv ${jobname}.* latex.d/. && mv latex.d/${jobname}.{org,pdf,fdb_latexmk,aux} .")
    ;; pdflatex -> .pdf
    (if (string-match "LATEX_CMD: pdflatex" (buffer-string))
        (setq texcmd "latexmk -pdflatex='pdflatex -shell-escape -interaction nonstopmode' -pdf -bibtex -f %f"))

    (if (string-match "LATEX_CMD: singularity" (buffer-string))
        (setq texcmd "singularity run --containall --bind $HOME/work/bibliography:$HOME/work/bibliography  --bind $PWD:/mnt --pwd /mnt   latex.sif   latexmk -pdflatex='pdflatex -shell-escape -interaction nonstopmode' -pdf -bibtex -f %f"))
    ;; xelatex -> .pdf
    (if (string-match "LATEX_CMD: xelatex" (buffer-string))
        (setq texcmd "latexmk -pdflatex='xelatex -shell-escape -interaction nonstopmode' -pdf -bibtex -f  %f"))
    ;; LaTeX compilation command
    (setq org-latex-pdf-process (list texcmd))))

(org-add-hook 'org-export-before-processing-hook 'sk-latexmk-cmd)

(unless (boundp 'org-latex-classes)
  (setq org-latex-classes nil))
#+END_SRC

** CV

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("CV"
               "\\documentclass[11pt]{article}
                                                        \\usepackage{\\string~\"/.emacs.d/latex_templates/cv\"}
                                                        [NO-DEFAULT-PACKAGES]
                                                        [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** NHMRC project grant

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("NHMRC_project_grant"
               "\\documentclass[12pt,table,names]{article}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/NHMRC_grant\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC
Rebuttal...
#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("NHMRC_project_grant_rebuttal"
               "\\documentclass[12pt,table,names]{article}
                                \\usepackage{\\string~\"/.emacs.d/latex_templates/NHMRC_grant\"}
                                [NO-DEFAULT-PACKAGES]
                                [NO-PACKAGES]"
               ("\\subsection{%s}" . "\\section*{%s}")
               ("\\subsubsection{%s}" . "\\subsection*{%s}")q
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

#+END_SRC

** NHMRC Investigator

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("NHMRC_investigator_grant"
               "\\documentclass[12pt,table,names]{article}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/NHMRC_investigator\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** ARC Discovery Grant

Main grant
#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("ARC_discovery_grant"
               "\\documentclass[12pt]{article}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/ARC_discovery\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")))
#+END_SRC

Special formatting for the ROPE sections.

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("ARC_ROPE"
               "\\documentclass[12pt]{article}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/ARC_discovery_ROPE\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")))
#+END_SRC

** Nature style paper

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes '("naturedef"
                                  "\\documentclass[fleqn,10pt]{wlscirep}
                        [NO-DEFAULT-PACKAGES]
                        [PACKAGES]
                        [EXTRA]"
                                  ("\\section{%s}" . "\\section*{%s}")
                                  ("\\subsection{%s}" . "\\subsection*{%s}")
                                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                                  ("\\paragraph{%s}" . "\\paragraph*{%s}")
                                  ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("nature"
               "\\documentclass[12pt]{article}
                                                        \\usepackage{\\string~\"/.emacs.d/latex_templates/nature\"}
                                                        [NO-DEFAULT-PACKAGES]
                                                        [NO-PACKAGES]"
               ("\\section*{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** Bioinformatics paper

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes '("bioinfo"
                                  "\\documentclass{bioinfo}
                        [NO-DEFAULT-PACKAGES]
                        [PACKAGES]
                        [EXTRA]"

                                  ("\\section{%s}" . "\\section*{%s}")
                                  ("\\subsection{%s}" . "\\subsection*{%s}")
                                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                                  ("\\paragraph{%s}" . "\\paragraph*{%s}")
                                  ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** Internal report

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("report"
               "\\documentclass[12pt]{article}
        \\usepackage{\\string~\"/.emacs.d/latex_templates/report\"}
[NO-DEFAULT-PACKAGES]
[NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** RoamCard
#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("roamcard"
               "\\documentclass[12pt,notitlepage]{article}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/roamcard\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+END_SRC

** Simple presentation

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             `("simplepresentation"
               ,(concat "\\documentclass[presentation]{beamer}\n"
                        "\\usepackage{\\string~\"/.emacs.d/latex_templates/simple\"}"
                        "[DEFAULT-PACKAGES]"
                        "[PACKAGES]"
                        "[EXTRA]\n")
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))

;;              '("simplepresentation"
;;                "\\documentclass[aspectratio=169,18pt,t]{beamer}
;; \\usepackage{\\string~\"/.emacs.d/latex_templates/simple\"}
;; [NO-DEFAULT-PACKAGES]
;; [NO-PACKAGES]"
;;                ("\\section{%s}" . "\\section*{%s}")
;;                ("\\begin{frame}[fragile]\\frametitle{%s}"
;;                 "\\end{frame}"
;;                 "\\begin{frame}[fragile]\\frametitle{%s}"
;;                 "\\end{frame}")))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(add-to-list 'org-latex-classes
             '("smallscreen"
               "\\documentclass[aspectratio=169,18pt,t]{beamer}
                \\usepackage{\\string~\"/.emacs.d/latex_templates/smallscreen\"}
                [NO-DEFAULT-PACKAGES]
                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\begin{frame}[fragile]\\frametitle{%s}"
                "\\end{frame}"
                "\\begin{frame}[fragile]\\frametitle{%s}"
                "\\end{frame}")))
#+END_SRC

** Fancier presentation

#+BEGIN_SRC emacs-lisp

(add-to-list 'org-latex-classes
             '("modernpresentation"
               "\\documentclass[14pt]{beamer}
                                                \\usepackage{\\string~\"/.emacs.d/latex_templates/modern\"}
                                                [NO-DEFAULT-PACKAGES]
                                                [NO-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\begin{frame}[fragile]\\frametitle{%s}"
                "\\end{frame}")))

#+END_SRC

* Server mode

#+BEGIN_SRC emacs-lisp
(prot-emacs-builtin-package 'server
  (add-hook 'after-init-hook #'server-start))
#+END_SRC


#+BEGIN_SRC emacs-lisp

;; (prot-emacs-builtin-package 'desktop
;;   (setq desktop-auto-save-timeout 300)
;;   (setq desktop-path `(,user-emacs-directory))
;;   (setq desktop-base-file-name "desktop")
;;   (setq desktop-files-not-to-save nil)
;;   (setq desktop-globals-to-clear nil)
;;   (setq desktop-load-locked-desktop t)
;;   (setq desktop-missing-file-warning nil)
;;   (setq desktop-restore-eager 0)
;;   (setq desktop-restore-frames nil)
;;   (setq desktop-save 'ask-if-new)
;;   (dolist (symbol '(kill-ring log-edit-comment-ring))
;;     (add-to-list 'desktop-globals-to-save symbol))

;;   (desktop-save-mode 1))

#+END_SRC

* PDF tools

#+BEGIN_SRC emacs-lisp

(prot-emacs-elpa-package 'pdf-tools
  ;; open pdfs scaled to fit page
  (setq-default pdf-view-display-size 'fit-page)
  ;; automatically annotate highlights
  (setq pdf-annot-activate-created-annotations t)
  ;; use normal isearch
  (let ((map pdf-view-mode-map))
    (define-key map (kbd "C-s") #'isearch-forward)))

#+END_SRC

#+BEGIN_SRC emacs-lisp

(prot-emacs-elpa-package 'org-pdftools
  :config
  ;; https://lists.gnu.org/archive/html/emacs-orgmode/2016-11/msg00169.html
  ;; Before adding, remove it (to avoid clogging)
  (delete '("\\.pdf\\'" . default) org-file-apps)
  ;; https://lists.gnu.org/archive/html/emacs-orgmode/2016-11/msg00176.html
  (add-to-list 'org-file-apps
               '("\\.pdf\\'" . (lambda (file link)
                                 (org-pdftools-open link)))))
#+END_SRC


Run this afterwards :
(pdf-tools-install)
p

The end.
icomplete-forward-completions
