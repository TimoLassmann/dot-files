#+TITLE:  Common commands to install missing packages 
#+AUTHOR: Timo Lassmann
#+EMAIL:  timo.lassmann@telethonkids.org.au
#+DATE:   2019-01-16
#+LATEX_CLASS: report
#+OPTIONS:  toc:nil
#+OPTIONS: H:4
#+LATEX_CMD: pdflatex
* Introduction 
  Essentials: 
#+BEGIN_SRC bash 


    sudo add-apt-repository universe
    sudo apt update
    sudo apt upgrade -y
    sudo apt  install zsh autoconf libtool make cmake git screen zsh r-base libboost-all-dev nfs-common nfs-kernel-server

#+END_SRC

* Add users 

  #+NAME: users 
  #+BEGIN_SRC bash 
    users=(alexia richard denise genevieve vanessa cathrine sarra jenefer melvin)
  #+END_SRC


  #+BEGIN_SRC bash -n :tangle add_user.sh :shebang #!/usr/bin/env bash :noweb yes
    DIR=`pwd`
    USERNAME=
    PASSWORD="password"
    function usage()
    {

        printf "This script will add users to a linux system.\n\n" ;
        printf "The default password is password and needs to be changed by the user.\n\n";
        printf "usage: $0 -n <user name> \n\n" ;
        exit 1;
    }

    while getopts n:  opt
    do

        case ${opt} in
            n) USERNAME=${OPTARG};;
            ,*) usage;;
        esac
    done
    if [ "${USERNAME}" == "" ]; then usage; fi

    echo "Creating user $USERNAME"

    sudo useradd  -b /data/workspace/ -g analysis -m $USERNAME
    
    echo "$USERNAME:password" | sudo chpasswd


    #+END_SRC

  #+BEGIN_SRC bash -n :tangle add_all_users.sh :shebang #!/usr/bin/env bash :noweb yes
    <<users>>

    echo "Current number of users: ${#users[*]}"

    echo "Users:"
    for item in ${users[*]}
    do
        printf "\t%s\n" $item
        ./add_user.sh -n $item
    done


  #+END_SRC  
  Create group analysis and add users 
  #+BEGIN_SRC bash 
sudo addgroup analysis
    ./add_all_users.sh
  #+END_SRC

* mounting NFS volumes 

  Create mount points 

  #+BEGIN_SRC bash 

    sudo mkdir -p /data/raw 
    sudo mkdir -p /data/workspace 

  #+END_SRC

  Mount the shares :
  #+BEGIN_SRC bash
    sudo mount honas03-tkiprod01.ichr.uwa.edu.au:/HOGRD01_RAWData /data/raw 
    sudo mount honas03-tkiprod01.ichr.uwa.edu.au:/HOGRD01_WorkSpace /data/workspace

  #+END_SRC

  Unmount:

  #+BEGIN_SRC bash
    sudo umount /data/raw 
    sudo umount /data/workspace 
  #+END_SRC

  To automatically mount disks when booting the machine add these lines to fstab: 

honas03-tkiprod01.ichr.uwa.edu.au:/HOGRD01_RAWData /data/raw  nfs defaults 0 0
honas03-tkiprod01.ichr.uwa.edu.au:/HOGRD01_WorkSpace /data/workspace nfs defaults 0 0




  Slurm: 
  #+BEGIN_SRC bash
    sudo apt install slurmd slurmctld slurm-client 

  #+END_SRC


  After this you should be able to see all nodes using the =sinfo= command. 

  sudo scontrol 

  update NodeName=hohpc98 State=DOWN Reason="undraining"
  update NodeName=hohpc98 State=RESUME
